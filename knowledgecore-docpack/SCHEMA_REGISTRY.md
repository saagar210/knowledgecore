# SCHEMA_REGISTRY.md

## Purpose
Authoritative registry of all versioned schemas and contracts. Any schema addition/change must update this file and include validation tests.

## Invariants
- Every schema has: name, version, canonical path, producer(s), consumer(s), invariants, compatibility rules, bump rules.
- Tier 1 schemas define ordering and hashing rules explicitly.
- RPC boundary types are schemas and must be versioned.

## Acceptance Tests
- Schema validation tests exist and run in CI for each schema category.
- Registry stays consistent with `spec/*` and `apps/desktop` types.

## Registry Table

| Schema | Ver | Path | Producer | Consumer | Tier | Invariants | Compat Rules | Bump Rules |
|---|---:|---|---|---|---|---|---|---|
| Canonical JSON | 1 | `spec/00-canonical-json.md` | kc_core | all | 1 | stable canonical JSON bytes | N/A | bump on encoding change |
| vault.json | 3 | `spec/32-sqlite-encryption-sqlcipher-v1.md` | kc_core | all | 1-adj | UUID vault_id; schema_version=3 for new vaults; v1/v2 normalized to v3 in memory; includes `db_encryption` block | read v1 + v2 + v3 during migration window | bump on breaking change |
| encryption metadata (object store) | 1 | `spec/27-encryption-at-rest-v1.md` | kc_core | kc_cli/src-tauri/ui settings | 1-adj | mode `object_store_xchacha20poly1305`; deterministic nonce derivation context; plaintext hash remains canonical | additive optional fields ok | bump on mode/kdf semantics change |
| SQLite schema | 1 | `spec/03-sqlite-schema-v1-and-migrations.md` | kc_core | all | 1 | migrations deterministic | additive ok | bump user_version on change |
| Locator v1 | 1 | `spec/10-locator-v1-and-resolver.md` | kc_core | all | 1 | [start,end) char indices; strict hash check | additive hints ok | bump on semantics change |
| Export manifest | 1 | `spec/12-export-bundles-and-manifest.md` | kc_core | verifier/UI | 1 | deterministic ordering; `vault_id` UUID; db hash; chunking_config_hash uses canonical config hashing; required `encryption`, `db_encryption`, and `recovery_escrow` blocks; object entries carry `hash` (plaintext hash), `storage_hash` (stored payload hash), and `encrypted` flag; `recovery_escrow` invariants are deterministic (`enabled=false => provider=none,updated_at_ms=null,descriptor=null`; `enabled=true => provider in {single,multi}, updated_at_ms integer, descriptor object`), and if present `providers[]` + `escrow_descriptors[]` are ordered by provider priority (`aws`,`gcp`,`azure`,`hsm`,`local`,`private_kms`) then lexical/provider_ref tie-breaks and use only supported provider ids from that set | additive blocks ok; legacy manifests without `providers[]`/`escrow_descriptors[]` remain verifiable | bump on ordering/hash or recovery escrow rule change |
| ZIP packaging metadata | 1 | `spec/28-deterministic-zip-packaging-v1.md` | kc_core | kc_cli verifier | 1 | entry order lexical; compression stored; fixed mtime `1980-01-01T00:00:00Z`; file mode `0644` | additive fields ok | bump on any deterministic ZIP policy change |
| Sync snapshots/head/conflict | 3 | `spec/31-sync-s3-transport-v1.md` + `spec/33-cross-device-passphrase-trust-v1.md` + `spec/35-device-trust-manual-verify-v1.md` + `spec/40-sync-head-signature-chain-v3.md` | kc_core | kc_cli/src-tauri/ui | 1 | deterministic snapshot id derivation `kc.sync.snapshot.v2`; deterministic head/conflict serialization; trust metadata required for schema_version>=2 heads; schema_version=3 heads require author identity chain fields (`author_device_id`, `author_fingerprint`, `author_signature`, `author_cert_id`, `author_chain_hash`) with deterministic signature payload hashing; no auto-merge | read v2 + v3 during migration window; emit v3 on new S3 head writes | bump on snapshot id, trust model, signature payload, lock protocol, or conflict semantics change |
| Sync merge preview report | 4 | `spec/37-sync-conservative-auto-merge-v1.md` | kc_core | kc_cli/src-tauri/ui | 1 | deterministic normalization/sorting for change-set arrays; deterministic overlap/reasons ordering; v2 adds deterministic `decision_trace` and conflict categories (`trust_chain_mismatch`, `lineage_lock_conflict`) for `conservative_plus_v2`; v3 adds `conservative_plus_v3` with deterministic reason categories (`safe_disjoint`, `unsafe_overlap_object`, `unsafe_overlay_overlap`, `unsafe_trust`, `unsafe_lock`, `unsafe_rbac`) and deterministic decision traces including RBAC conflict state; v4 adds `conservative_plus_v4` deterministic categories (`safe_disjoint_v4`, `unsafe_object_overlap_v4`, `unsafe_overlay_overlap_v4`, `unsafe_trust_chain_v4`, `unsafe_lock_scope_v4`, `unsafe_rbac_v4`) plus deterministic trace cardinality marker (`unsafe_reason_count`) | read v1 + v2 + v3 + v4 during transition; emit v2 for `conservative_plus_v2`, v3 for `conservative_plus_v3`, and v4 for `conservative_plus_v4` | bump on merge policy semantics, ordering rules, or overlap logic |
| Sync target URI | 2 | `spec/31-sync-s3-transport-v1.md` | kc_core | kc_cli/src-tauri/ui | 1-adj | supports `file://`, plain path, and `s3://bucket/prefix`; deterministic canonical target display | additive optional schemes need explicit review | bump on parse semantics or supported scheme changes |
| Device trust manifest | 1 | `spec/35-device-trust-manual-verify-v1.md` | kc_core | kc_cli/src-tauri/ui | 1-adj | ed25519 device identity; deterministic fingerprint formatting and trust event ordering; unverified devices cannot author accepted remote heads | additive optional metadata fields ok | bump on fingerprint/signature payload semantics |
| Trust identity/session | 2 | `spec/39-managed-identity-oidc-device-cert-v1.md` + `spec/42-trust-provider-governance-v1.md` + `spec/43-identity-session-policy-v2.md` | kc_core | kc_cli/src-tauri/ui | 1-adj | deterministic OIDC claim subset canonical JSON; provider lifecycle ordering (`provider_id` lexicographic) including deterministic issuer discovery IDs; deterministic tenant-template policy canonicalization (`aud`,`iss`,`tenant` keys); deterministic policy claim ordering (`claim_key`,`claim_value`); deterministic session selection ordering (`created_at_ms`, `session_id`) with revocation precedence; deterministic certificate chain hash derivation (`cert_id`, `device_id`, `fingerprint`) | read v1 + v2 during migration window; emit v2 when provider governance/session policy tables are active | bump on claim subset normalization, discovery ID derivation, provider/policy evaluation order, session selection precedence, or chain-hash derivation semantics |
| Recovery bundle manifest | 2 | `spec/36-local-recovery-kit-v1.md` | kc_core | kc_cli/src-tauri/ui | 1-adj | deterministic `recovery_manifest.json` canonical bytes with checksum + payload hash; optional deterministic `escrow` descriptor block (`provider`,`provider_ref`,`key_id`,`wrapped_at_ms`) and optional `escrow_descriptors[]` extension for multi-provider reporting | read v1 + v2 during migration window; emit v2 on new writes | bump on checksum/payload derivation semantics or escrow descriptor semantics |
| Lineage query | 2 | `spec/34-lineage-overlays-v1.md` | kc_core | kc_cli/src-tauri/ui | 1 | deterministic nodes (`kind`,`node_id`) and edges (`from`,`to`,`relation`,`evidence`,`origin`) ordering; v2 merges immutable system edges with overlay edges deterministically | v1 read-only response remains supported during transition | bump on request/response semantics or ordering rule change |
| Lineage overlay entry | 1 | `spec/34-lineage-overlays-v1.md` | kc_core | kc_cli/src-tauri/ui | 1-adj | overlay_id deterministic hash identity; uniqueness on `(doc_id,from,to,relation,evidence)`; immutable system lineage untouched | additive optional metadata fields ok | bump on identity or ordering semantics change |
| Lineage governance (roles + locks + policy conditions) | 4 | `spec/41-lineage-governance-rbac-v2.md` + `spec/38-lineage-collab-turn-lock-v1.md` + `spec/45-lineage-governance-conditions-v3.md` | kc_core | kc_cli/src-tauri/ui | 1-adj | deterministic RBAC precedence by `role_rank,subject_id,role_name`; overlay mutation requires lock + RBAC allow + policy-condition allow; policy evaluation deny-default with explicit deny override and deterministic tie-break (`priority`,`policy_id`,`subject_id`); v4 condition DSL adds deterministic optional keys `doc_id_suffix` and `subject_id_prefix` in addition to `action` + `doc_id_prefix`; deterministic audit details canonical JSON and deterministic audit ordering (`ts_ms`,`audit_id`); scoped lock schemas support `scope_kind` in `{doc,set}` with deterministic token/status serialization | read v1 + v2 + v3 governance artifacts during transition; emit v4 policy-condition artifacts on new/updated policy writes | bump on role/policy precedence, permission semantics, condition key semantics, audit ordering, scope enum, or lock/token derivation |
| Verifier report | 1 | `spec/13-verifier-and-reporting.md` | kc_cli | UI/automation | 1 | stable exit codes (0/20/21/31/40/41/60); deterministic ordering; schema-validated manifest input; object encryption-state mismatches map into code 41 and DB encryption-state mismatches map into code 31 | additive ok | bump on exit/order/schema rule change |
| AppError | 1 | `spec/14-error-contract-app-error-taxonomy.md` | all | UI/CLI/RPC | 1-adj | UI branches on code only | additive codes ok | bump on struct change |
| Trace log | 1 | `spec/17-trace-log-schema-and-redaction.md` | kc_ask | UI/automation | 1 | `trace_id`/`vault_id` UUID; deterministic retrieval chunk ordering + locator ordering | additive ok | bump on struct change |
| RPC envelope | 1 | `spec/19-tauri-rpc-surface.md` | src-tauri | UI | 1-adj | strict one-of envelope; methods include lock-session RPC (`vault_lock_status`, `vault_unlock`, `vault_lock`), trust identity/device RPC (`trust_identity_start/complete`, `trust_device_enroll/verify_chain/list`) plus trust provider governance RPC (`trust_provider_add/disable/list/discover`, `trust_policy_set`, `trust_policy_set_tenant_template`), `ingest_inbox_start/stop`, `vault_encryption_status/enable/migrate`, recovery RPC (`vault_recovery_status/generate/verify` and escrow RPC `vault_recovery_escrow_status/enable/rotate/restore/provider_add/provider_list/rotate_all`), sync merge preview RPC (`sync_merge_preview`) with optional `policy` (`conservative`, `conservative_plus_v2`, `conservative_plus_v3`, or `conservative_plus_v4`) and sync pull auto-merge option (`sync_pull.auto_merge`) with matching modes; lineage v2 + overlay RPCs (`lineage_query_v2`, `lineage_overlay_add/remove/list`), lineage lock RPCs (`lineage_lock_acquire/release/status`), lineage role RPCs (`lineage_role_grant/revoke/list`), lineage policy RPCs (`lineage_policy_add/bind/list`) with v4 condition-key support (`action`,`doc_id_prefix`,`doc_id_suffix`,`subject_id_prefix`), and scoped lock RPC (`lineage_lock_acquire_scope`); deterministic reqs carry caller-controlled timestamps (`now_ms`/`created_at_ms`) | additive methods ok | bump on breaking change |

## Draft Schemas (Phase L, non-runtime)

- Phase L draft runtime scaffolding was retired in R1 after O/P/Q activation.
- Design-lock specs `22`â€“`26` remain archival references and are not runtime contracts.

## Schema validation workflow
- JSON schema validation tests (Rust `jsonschema` crate):
  - `cargo test -p kc_core -- schema_*`
  - `cargo test -p kc_cli -- schema_*`
- RPC round-trip serialization tests:
  - `cargo test -p apps_desktop_tauri -- rpc_*`
  - Deterministic RPC request schema tests:
    - `cargo test -p apps_desktop_tauri -- rpc_schema_*`

## Assumption
- Formal JSON Schemas are embedded in spec files and mirrored into Rust tests as literals to validate at build time.
